-- ================================================================================================
-- 📂 项目：拾光谣 - 设置管理员角色
-- 📝 版本：v1.0
-- 🎯 目标：将指定用户设置为管理员，解决预约记录不显示的问题
-- 📅 日期：2026-02-04
-- ================================================================================================

-- ================================================================================================
-- 问题说明
-- ================================================================================================
-- 问题：管理员端预约管理界面不显示预约记录
-- 原因：RLS 策略要求 profiles.role = 'admin'，但新用户注册时默认 role = 'user'
-- 解决：手动将管理员用户的 role 更新为 'admin'
-- ================================================================================================

-- ================================================================================================
-- 方案 1：通过邮箱设置管理员（推荐）
-- ================================================================================================
-- 使用说明：将下面的 'admin@example.com' 替换为实际的管理员邮箱

-- UPDATE public.profiles
-- SET role = 'admin'
-- WHERE email = 'admin@example.com';

-- ================================================================================================
-- 方案 2：通过用户 ID 设置管理员
-- ================================================================================================
-- 使用说明：将下面的 'user-uuid-here' 替换为实际的用户 ID

-- UPDATE public.profiles
-- SET role = 'admin'
-- WHERE id = 'user-uuid-here'::uuid;

-- ================================================================================================
-- 方案 3：查询当前所有用户及其角色
-- ================================================================================================
-- 使用此查询找到需要设置为管理员的用户

SELECT
  id,
  email,
  name,
  nickname,
  role,
  created_at
FROM public.profiles
ORDER BY created_at;

-- ================================================================================================
-- 验证管理员设置
-- ================================================================================================
-- 执行更新后，使用此查询验证管理员角色是否设置成功

-- SELECT
--   id,
--   email,
--   role
-- FROM public.profiles
-- WHERE role = 'admin';

-- ================================================================================================
-- 完成
-- ================================================================================================

DO $$
BEGIN
  RAISE NOTICE '✅ 管理员角色设置脚本已准备就绪！';
  RAISE NOTICE '📋 请按照以下步骤操作：';
  RAISE NOTICE '   1. 执行上面的 SELECT 查询，找到需要设置为管理员的用户';
  RAISE NOTICE '   2. 取消注释方案 1 或方案 2，并替换为实际的邮箱或用户 ID';
  RAISE NOTICE '   3. 执行 UPDATE 语句';
  RAISE NOTICE '   4. 使用验证查询确认设置成功';
  RAISE NOTICE '   5. 刷新管理员端预约管理界面，应该能看到预约记录了';
END $$;
