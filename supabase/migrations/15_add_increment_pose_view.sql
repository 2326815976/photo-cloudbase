-- ================================================================================================
-- 📂 项目：拾光谣 - 摆姿浏览量更新函数
-- 📝 版本：v1.0
-- 🎯 目标：创建 increment_pose_view RPC 函数，用于原子性更新摆姿浏览量
-- 📅 日期：2026-02-09
-- ================================================================================================

-- ================================================================================================
-- 1. 创建摆姿浏览量递增函数
-- ================================================================================================

-- 原子性递增摆姿浏览量
CREATE OR REPLACE FUNCTION public.increment_pose_view(p_pose_id int)
RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  -- 原子性更新浏览量
  UPDATE public.poses
  SET view_count = view_count + 1
  WHERE id = p_pose_id;

  -- 如果没有找到对应的摆姿，不抛出错误，静默处理
  -- 这样可以避免前端因为无效ID而收到错误
END;
$$;

COMMENT ON FUNCTION public.increment_pose_view(int) IS '原子性递增指定摆姿的浏览量';

-- ================================================================================================
-- 2. 授予执行权限
-- ================================================================================================

-- 允许匿名用户和认证用户调用此函数
GRANT EXECUTE ON FUNCTION public.increment_pose_view(int) TO anon, authenticated;

-- ================================================================================================
-- 完成
-- ================================================================================================

DO $$
BEGIN
  RAISE NOTICE '✅ increment_pose_view 函数创建完成！';
  RAISE NOTICE '📊 功能：原子性递增摆姿浏览量';
  RAISE NOTICE '🔒 权限：anon 和 authenticated 用户可调用';
END $$;
