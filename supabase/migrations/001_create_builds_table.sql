-- ================================================================================================
-- ğŸ“‚ é¡¹ç›®ï¼šæ‹¾å…‰è°£ (Time Ballad) - Next.js + Supabase å…¨æ ˆæ¶æ„
-- ğŸ“ ç‰ˆæœ¬ï¼šv5.0_Final 
-- ğŸ¤– AI é˜…è¯»æŒ‡å—ï¼š
--    1. æœ¬æ–‡ä»¶æ˜¯æ•°æ®åº“çš„ã€å”¯ä¸€çœŸç†æºã€‘ã€‚è¯·å‹¿æ“…è‡ªä¿®æ”¹å­—æ®µåã€‚
--    2. æ³¨é‡Šä¸­çš„ [ğŸ”¥ æ ¸å¿ƒé€»è¾‘] ä»£è¡¨ä¸šåŠ¡å…³é”®è§„åˆ™ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆã€‚
--    3. æ³¨é‡Šä¸­çš„ [ğŸ’» å‰ç«¯å¯¹æ¥] ä»£è¡¨ UI å¼€å‘æ—¶çš„å–æ•°é€»è¾‘ã€‚
--    4. æ‰€æœ‰çš„ RLS (Row Level Security) ç­–ç•¥å·²åœ¨æ­¤å®šä¹‰ï¼Œå‰ç«¯æ— éœ€åœ¨å®¢æˆ·ç«¯å±‚å¤„ç†æƒé™è¿‡æ»¤ã€‚
-- ================================================================================================

-- [å…¨å±€é…ç½®] å¼ºåˆ¶è®¾ç½®ä¸Šæµ·æ—¶åŒºï¼Œé˜²æ­¢æ—¥æœŸåå·®
alter database postgres set timezone to 'Asia/Shanghai';

-- åˆå§‹åŒ– UUID ç”Ÿæˆæ‰©å±•
create extension if not exists "uuid-ossp";

-- ================================================================================================
-- 1. ç”¨æˆ·ç³»ç»Ÿ (Profiles)
-- ================================================================================================

-- è¡¨ï¼šç”¨æˆ·æ¡£æ¡ˆ
create table if not exists public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  email text,
  name text,        
  avatar text,
  role text default 'user' check (role in ('user', 'admin')), 
  
  -- ç®¡ç†å‘˜æ”¶æ¬¾ç  (ä»…å½“ role='admin' æ—¶æœ‰æ„ä¹‰)
  payment_qr_code text, 
  
  created_at timestamptz default now(),
  last_active_at timestamptz 
);

alter table public.profiles enable row level security;
create policy "Public view profiles" on profiles for select using (true); -- å…è®¸æŸ¥çœ‹ä»–äººåŸºç¡€ä¿¡æ¯(å¦‚å¤´åƒ)
create policy "User update own" on profiles for update using (auth.uid() = id);

-- ================================================================================================
-- 2. ç³»ç»Ÿä¸æšä¸¾ (System & Config)
-- ================================================================================================

-- è¡¨ï¼šå¾…åˆ é™¤æ–‡ä»¶é˜Ÿåˆ— (ç”¨äºç»•è¿‡ Edge Function è¶…æ—¶é™åˆ¶)
-- [ğŸ”¥ æ ¸å¿ƒé€»è¾‘] ä¸šåŠ¡è¡¨åˆ é™¤å›¾ç‰‡è®°å½•åï¼Œè§¦å‘å™¨ä¼šè‡ªåŠ¨å¾€è¿™é‡Œå†™ä¸€æ¡ã€‚
-- ä½ éœ€è¦é…ç½®ä¸€ä¸ª Cron Job (å®šæ—¶ä»»åŠ¡) æ¯å¤©è°ƒç”¨ Edge Function è¯»å–æ­¤è¡¨å¹¶æ‰§è¡Œ storage.remove()ã€‚
create table if not exists public.sys_storage_delete_queue (
  id bigint generated by default as identity primary key,
  bucket_name text not null, -- 'albums' | 'poses'
  file_path text not null,   
  created_at timestamptz default now()
);
alter table public.sys_storage_delete_queue enable row level security;
-- ä»…ç®¡ç†å‘˜å¯è¯»ï¼ˆç”¨äºæ¸…ç†è„šæœ¬ï¼‰
create policy "Admin only queue" on sys_storage_delete_queue for select using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- [æ–°å¢] è¡¨ï¼šçº¦æ‹ç±»å‹é…ç½®
-- [ğŸ’» å‰ç«¯å¯¹æ¥] é¢„çº¦é¡µé¢çš„ä¸‹æ‹‰èœå•è¯·ä»è¿™é‡Œè¯»å–æ•°æ® (WHERE is_active = true)ã€‚
create table if not exists public.booking_types (
  id int generated by default as identity primary key,
  name text not null, -- ä¾‹å¦‚: 'äº’å‹‰', 'JKåˆ¶æœ', 'å©šç¤¼è·Ÿæ‹'
  is_active boolean default true, -- ç®¡ç†å‘˜å¯è½¯åˆ é™¤
  created_at timestamptz default now()
);
-- é¢„è®¾æ•°æ®
insert into public.booking_types (name) values ('äº’å‹‰'), ('å¸¸è§„çº¦æ‹'), ('å©šç¤¼è·Ÿæ‹'), ('æ´»åŠ¨è®°å½•');

alter table public.booking_types enable row level security;
create policy "Public read types" on booking_types for select using (true);
create policy "Admin manage types" on booking_types for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- ================================================================================================
-- 3. ç»Ÿè®¡ç³»ç»Ÿ (Analytics)
-- ================================================================================================

-- è¡¨ï¼šç”¨æˆ·æ—¥æ´»æµæ°´
create table if not exists public.user_active_logs (
  user_id uuid references auth.users(id) on delete cascade not null,
  active_date date default current_date, 
  created_at timestamptz default now(),
  primary key (user_id, active_date) -- è”åˆä¸»é”®ç¡®ä¿æ¯æ—¥æ¯äººåªæœ‰ä¸€æ¡
);

-- è¡¨ï¼šä»ªè¡¨ç›˜æ¯æ—¥å¿«ç…§ (ç¼“å­˜è¡¨ï¼Œæå¤§æå‡åå°åŠ è½½é€Ÿåº¦)
create table if not exists public.analytics_daily (
  date date primary key default current_date,
  new_users_count int default 0,    
  active_users_count int default 0 
);

alter table public.user_active_logs enable row level security;
alter table public.analytics_daily enable row level security;
create policy "Log write" on user_active_logs for insert with check (auth.uid() = user_id);
create policy "Admin read stats" on analytics_daily for select using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- ================================================================================================
-- 4. æ‘†å§¿èµ„æº (Poses)
-- ================================================================================================

-- è¡¨ï¼šæ‹ç…§å§¿åŠ¿
-- [ğŸ’» å‰ç«¯å¯¹æ¥] é¦–é¡µæ‘‡ä¸€æ‘‡æ•°æ®æºã€‚
create table if not exists public.poses (
  id bigint generated by default as identity primary key,
  image_url text not null, -- Public Bucket URL
  storage_path text, 
  tags text[], 
  view_count int default 0, 
  created_at timestamptz default now()
);

create index if not exists poses_tags_idx on public.poses using gin (tags); -- åŠ é€Ÿæ ‡ç­¾æœç´¢

alter table public.poses enable row level security;
create policy "Public read poses" on poses for select using (true);
create policy "Admin manage poses" on poses for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- ================================================================================================
-- 5. ä¸“å±è¿”å›¾ç©ºé—´ (Albums)
-- ================================================================================================

-- è¡¨ï¼šç›¸å†Œ
-- [ğŸ”¥ æ ¸å¿ƒé€»è¾‘] RLS é»˜è®¤ä¸ºå…³é—­ (False)ã€‚è¿™æ„å‘³ç€ä»»ä½• SELECT * FROM albums éƒ½ä¼šè¿”å›ç©ºã€‚
-- å¿…é¡»é€šè¿‡ RPC `get_album_content(key)` æºå¸¦å¯†é’¥æ‰èƒ½è®¿é—®æ•°æ®ã€‚
create table if not exists public.albums (
  id uuid default gen_random_uuid() primary key,
  access_key text not null unique, -- è®¿é—®å¯†é’¥
  title text,
  cover_url text, 
  welcome_letter text, -- ç®¡ç†å‘˜å¯„è¯­
  enable_tipping boolean default true,
  created_at timestamptz default now()
);
alter table public.albums enable row level security;
create policy "Admin manage albums" on albums for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- è¡¨ï¼šç›¸å†Œæ–‡ä»¶å¤¹
create table if not exists public.album_folders (
  id uuid default gen_random_uuid() primary key,
  album_id uuid references public.albums(id) on delete cascade not null,
  name text not null,
  created_at timestamptz default now()
);
alter table public.album_folders enable row level security;
create policy "Admin manage folders" on album_folders for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- ================================================================================================
-- 6. ç…§ç‰‡ä¸äº’åŠ¨ (Photos, Comments, Likes)
-- ================================================================================================

-- è¡¨ï¼šç…§ç‰‡
create table if not exists public.album_photos (
  id uuid default gen_random_uuid() primary key,
  album_id uuid references public.albums(id) on delete cascade not null,
  folder_id uuid references public.album_folders(id) on delete set null,
  
  url text not null,      -- Private Bucket Path (éœ€è¦ç­¾å)
  width int, height int,  -- ç”¨äºç€‘å¸ƒæµå¸ƒå±€
  blurhash text,          -- ç”¨äºåŠ è½½å ä½
  
  is_public boolean default false, -- [é‡è¦] True åˆ™å‡ºç°åœ¨ç…§ç‰‡å¢™
  
  view_count int default 0,
  like_count int default 0, 
  rating int default 0,     
  created_at timestamptz default now()
);

-- [ç´¢å¼•ä¼˜åŒ–] åŠ é€Ÿç…§ç‰‡å¢™æŸ¥è¯¢
create index if not exists idx_photos_public_wall on public.album_photos(created_at desc) where is_public = true;

-- è¡¨ï¼šç…§ç‰‡è¯„è®º
-- [ğŸ”¥ æ ¸å¿ƒå®‰å…¨] è¯„è®ºåŠŸèƒ½ä»…é™ã€ä¸“å±ç©ºé—´ã€‘å†…éƒ¨ã€‚ç…§ç‰‡å¢™(Public Wall)ä¸æ˜¾ç¤ºä¹Ÿä¸å…è®¸è¯„è®ºã€‚
create table if not exists public.photo_comments (
  id bigint generated by default as identity primary key,
  photo_id uuid references public.album_photos(id) on delete cascade not null,
  user_id uuid references auth.users(id) on delete set null,
  nickname text default 'è®¿å®¢', -- ä»…å½“ user_id ä¸ºç©ºæ—¶ä½¿ç”¨
  content text not null,
  is_admin_reply boolean default false, 
  created_at timestamptz default now()
);

-- è¡¨ï¼šç‚¹èµ
-- [ğŸ”¥ æ ¸å¿ƒå®‰å…¨] åªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥ç‚¹èµã€‚
create table if not exists public.photo_likes (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade not null, -- Not Null å¼ºåˆ¶ç™»å½•
  photo_id uuid references public.album_photos(id) on delete cascade not null,
  created_at timestamptz default now(),
  unique(user_id, photo_id) -- é˜²æ­¢é‡å¤ç‚¹èµ
);

-- RLS ç­–ç•¥è®¾ç½®
alter table public.album_photos enable row level security;
alter table public.photo_comments enable row level security;
alter table public.photo_likes enable row level security;

-- 1. ç…§ç‰‡æƒé™ï¼šå…¬å¼€çš„å¯çœ‹ï¼Œç®¡ç†å‘˜å…¨æƒ
create policy "Public photos visible" on album_photos for select using (is_public = true);
create policy "Admin manage photos" on album_photos for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- 2. è¯„è®ºæƒé™ï¼š
-- [æ³¨æ„] è¿™é‡Œåªå¼€å¯ SELECTã€‚INSERT æƒé™è¢«å®Œå…¨å…³é—­ï¼Œå¿…é¡»é€šè¿‡ RPC å†™å…¥ã€‚
-- è¿™æ ·ç¡®ä¿äº†æ²¡æœ‰äººèƒ½ç»•è¿‡åç«¯é€»è¾‘ï¼ˆå¦‚æ£€æŸ¥å¯†é’¥ï¼‰ç›´æ¥å†™åº“ã€‚
create policy "View comments" on photo_comments for select using (true);
create policy "Admin manage comments" on photo_comments for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- 3. ç‚¹èµæƒé™ï¼šä»…ç™»å½•ç”¨æˆ·å¯æ’å…¥ï¼Œä¸”åªèƒ½åˆ è‡ªå·±çš„
create policy "User like" on photo_likes for insert with check (auth.uid() = user_id);
create policy "User unlike" on photo_likes for delete using (auth.uid() = user_id);
create policy "Public view likes" on photo_likes for select using (true);

-- ================================================================================================
-- 7. é¢„çº¦ç³»ç»Ÿ (Bookings)
-- ================================================================================================

-- è¡¨ï¼šç®¡ç†å‘˜é”æ¡£æœŸ (ä¼‘å‡è®¾ç½®)
create table if not exists public.booking_blackouts (
  id int generated by default as identity primary key,
  date date not null unique, 
  reason text,
  created_at timestamptz default now()
);
alter table public.booking_blackouts enable row level security;
create policy "Public read blackouts" on booking_blackouts for select using (true);
create policy "Admin manage blackouts" on booking_blackouts for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- è¡¨ï¼šé¢„çº¦å•
create table if not exists public.bookings (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users(id) not null,
  
  -- å…³è”åˆ°é…ç½®è¡¨
  type_id int references public.booking_types(id), 
  
  booking_date date not null,
  time_slot_start time not null, 
  time_slot_end time not null,   
  location text not null,
  phone text not null,
  wechat text,
  contact_info jsonb,    
  notes text,
  
  status text default 'pending', -- pending | confirmed | finished | cancelled
  bound_album_id uuid references public.albums(id) on delete set null,
  admin_notes text,      
  created_at timestamptz default now()
);

-- [ğŸ”¥ æ ¸å¿ƒçº¦æŸ] 
-- 1. æ¯å¤©åªæ¥ä¸€å• (çŠ¶æ€éå–æ¶ˆ)
create unique index if not exists unique_active_daily_booking on bookings (booking_date) where status != 'cancelled';
-- 2. æ¯ä¸ªç”¨æˆ·åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªè¿›è¡Œä¸­çš„è®¢å•
create unique index if not exists one_active_booking_per_user on bookings (user_id) where status in ('pending', 'confirmed');

alter table public.bookings enable row level security;
create policy "User own bookings" on bookings for all using (auth.uid() = user_id);
create policy "Admin all bookings" on bookings for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- [Trigger] çº¦æ‹å½“å¤©ä¸å¯å–æ¶ˆç­–ç•¥
create or replace function public.check_cancellation_policy()
returns trigger language plpgsql security definer as $$
declare
  is_admin boolean;
begin
  if new.status = 'cancelled' and old.status != 'cancelled' then
    -- å¼ºåˆ¶ä½¿ç”¨ä¸Šæµ·æ—¶é—´åˆ¤æ–­
    if (now() at time zone 'Asia/Shanghai')::date >= old.booking_date then
      select (role = 'admin') into is_admin from public.profiles where id = auth.uid();
      if is_admin is not true then
        raise exception 'é¢„çº¦æ—¥æœŸå½“å¤©å·²æ— æ³•è‡ªè¡Œå–æ¶ˆï¼Œè¯·è”ç³»æ‘„å½±å¸ˆã€‚';
      end if;
    end if;
  end if;
  return new;
end;
$$;
create trigger trigger_check_cancellation before update on public.bookings for each row execute procedure public.check_cancellation_policy();

-- ================================================================================================
-- 8. ç‰ˆæœ¬å‘å¸ƒ (Releases)
-- ================================================================================================
create table if not exists public.app_releases (
  id bigint generated by default as identity primary key,
  version text not null,       
  platform text not null,      
  download_url text not null,
  update_log text,
  created_at timestamptz default now()
);
alter table public.app_releases enable row level security;
create policy "Public read releases" on app_releases for select using (true);
create policy "Admin manage releases" on app_releases for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- ================================================================================================
-- 9. æ ¸å¿ƒ RPC æ¥å£ (å‰ç«¯è°ƒç”¨å±‚)
-- ================================================================================================

-- 1. æ£€æŸ¥æ—¥æœŸæ˜¯å¦å¯é¢„çº¦
-- [ğŸ’» å‰ç«¯å¯¹æ¥] å¦‚æœè¿”å› falseï¼Œæ—¥å†ä¸Šè¯¥æ—¥æœŸç½®ç°ã€‚
create or replace function public.check_date_availability(target_date date)
returns boolean language plpgsql security definer as $$
begin
  -- æ£€æŸ¥æ˜¯å¦è¢«ç®¡ç†å‘˜é”ä½
  if exists (select 1 from public.booking_blackouts where date = target_date) then
    return false;
  end if;
  -- æ£€æŸ¥æ˜¯å¦å·²æœ‰è®¢å•
  if exists (select 1 from public.bookings where booking_date = target_date and status != 'cancelled') then
    return false;
  end if;
  return true;
end;
$$;

-- 2. å‘è¡¨è¯„è®º (å¸¦å¯†é’¥æ ¡éªŒ)
-- [ğŸ”¥ å®‰å…¨æ ¸å¿ƒ] æ— è®ºæ˜¯å¦ç™»å½•ï¼Œå¿…é¡»æä¾›æ­£ç¡®çš„ access_key æ‰èƒ½è¯„è®ºã€‚
-- è¿™ä¿è¯äº†åªèƒ½åœ¨ã€ä¸“å±ç©ºé—´ã€‘å†…è¯„è®ºï¼Œæ— æ³•åœ¨ã€ç…§ç‰‡å¢™ã€‘è¯„è®ºï¼ˆå› ä¸ºç…§ç‰‡å¢™æ²¡æœ‰ Keyï¼‰ã€‚
create or replace function public.post_album_comment(
  p_access_key text,
  p_photo_id uuid,
  p_content text
)
returns void language plpgsql security definer as $$
declare
  valid_album_id uuid;
  v_user_id uuid;
begin
  v_user_id := auth.uid(); -- è·å–å½“å‰ç”¨æˆ·ID

  -- è¶Šæƒæ£€æµ‹ï¼šéªŒè¯ Key æ˜¯å¦å¯¹åº”ç…§ç‰‡æ‰€å±ç›¸å†Œ
  select a.id into valid_album_id
  from public.albums a
  join public.album_photos p on p.album_id = a.id
  where a.access_key = p_access_key and p.id = p_photo_id;

  if valid_album_id is null then
    raise exception 'æ— æƒæ“ä½œï¼šå¯†é’¥é”™è¯¯æˆ–ç…§ç‰‡ä¸å±äºè¯¥ç©ºé—´';
  end if;

  insert into public.photo_comments (photo_id, user_id, content, nickname)
  values (p_photo_id, v_user_id, p_content, case when v_user_id is null then 'è®¿å®¢' else null end);
end;
$$;

-- 3. è·å–ä¸“å±ç›¸å†Œè¯¦æƒ…
-- [ğŸ’» å‰ç«¯å¯¹æ¥] è¿”å›ç›¸å†Œä¿¡æ¯ + æ–‡ä»¶å¤¹åˆ—è¡¨ + ç…§ç‰‡åˆ—è¡¨
create or replace function public.get_album_content(input_key text)
returns jsonb language plpgsql security definer as $$
declare
  target_album_id uuid;
  result jsonb;
begin
  select id into target_album_id from public.albums where access_key = input_key;
  if target_album_id is null then return null; end if;

  select jsonb_build_object(
    'album', (
        select jsonb_build_object(
            'id', id, 'title', title, 'welcome_letter', welcome_letter, 'cover_url', cover_url, 'enable_tipping', enable_tipping,
            'admin_qr_path', (select payment_qr_code from profiles where role='admin' limit 1)
        ) from public.albums where id = target_album_id
    ),
    'folders', (
        select coalesce(json_agg(jsonb_build_object('id', id, 'name', name)), '[]'::json)
        from public.album_folders where album_id = target_album_id
    ),
    'photos', (
       select coalesce(json_agg(
           jsonb_build_object(
               'id', id, 'folder_id', folder_id, 'storage_path', url,
               'width', width, 'height', height, 'blurhash', blurhash,
               'is_public', is_public, 'rating', rating,
               -- ä»…åœ¨ä¸“å±ç©ºé—´å†…è¿”å›è¯„è®ºæ•°æ®
               'comments', (
                   select coalesce(json_agg(
                       jsonb_build_object('nickname', nickname, 'content', content, 'is_admin', is_admin_reply, 'created_at', created_at)
                   ), '[]'::json) 
                   from public.photo_comments where photo_id = album_photos.id order by created_at asc
               )
           ) order by created_at desc
       ), '[]'::json)
       from public.album_photos where album_id = target_album_id
    )
  ) into result;
  
  return result;
end;
$$;

-- 4. è·å–ç…§ç‰‡å¢™ (å…¬å¼€)
-- [ğŸ”¥ æ ¸å¿ƒé€»è¾‘] è¿™é‡Œæ•…æ„ã€ä¸è¿”å›ã€‘ comments å­—æ®µã€‚
-- å³ä½¿æ•°æ®åº“é‡Œæœ‰è¯„è®ºï¼ˆæ¥è‡ªä¸“å±ç©ºé—´ï¼‰ï¼Œåœ¨ç…§ç‰‡å¢™ä¸Šä¹Ÿæ‹¿ä¸åˆ°æ•°æ®ï¼Œå½»åº•é˜²æ­¢æ˜¾ç¤ºã€‚
create or replace function public.get_public_gallery(page_no int, page_size int)
returns jsonb language sql security definer as $$
  select json_agg(t) from (
    select 
      p.id, p.url as storage_path, p.width, p.height, p.blurhash, 
      p.like_count, p.view_count, p.created_at,
      -- æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹è¿‡èµ (è¿”å› boolean)
      exists(select 1 from public.photo_likes pl where pl.photo_id = p.id and pl.user_id = auth.uid()) as is_liked
    from public.album_photos p
    where p.is_public = true
    order by p.created_at desc
    limit page_size
    offset (page_no - 1) * page_size
  ) t;
$$;

-- ================================================================================================
-- 10. è‡ªåŠ¨åŒ– Triggers
-- ================================================================================================

-- æ–°ç”¨æˆ·æ³¨å†Œ -> å†™å…¥ Profiles
create or replace function public.handle_new_user() returns trigger language plpgsql security definer as $$
begin
  insert into public.profiles (id, email, name, role)
  values (
    new.id,
    new.email,
    coalesce(new.raw_user_meta_data->>'name', split_part(new.email, '@', 1)),
    'user'
  );
  -- å°è¯•æ›´æ–°æ—¥å¢ç”¨æˆ·ç»Ÿè®¡
  insert into public.analytics_daily (date, new_users_count) values (current_date, 1)
  on conflict (date) do update set new_users_count = analytics_daily.new_users_count + 1;
  return new;
end; $$;
create trigger on_auth_user_created after insert on auth.users for each row execute procedure public.handle_new_user();

-- åˆ é™¤ç…§ç‰‡ -> åŠ å…¥åˆ é™¤é˜Ÿåˆ—
create or replace function public.queue_storage_deletion() returns trigger language plpgsql security definer as $$
begin
  -- æ ¹æ®è¡¨ååˆ¤æ–­å­˜å‚¨æ¡¶å’Œå­—æ®µå
  if TG_TABLE_NAME = 'album_photos' and old.url is not null then
    insert into public.sys_storage_delete_queue (bucket_name, file_path)
    values ('albums', old.url);
  elsif old.storage_path is not null then
    insert into public.sys_storage_delete_queue (bucket_name, file_path)
    values ('poses', old.storage_path);
  end if;
  return old;
end; $$;
create trigger on_photo_deleted after delete on public.album_photos for each row execute procedure public.queue_storage_deletion();

-- é­”æ³•è¿‡æœŸé€»è¾‘ (å¯é…åˆ pg_cron æˆ–å¤–éƒ¨å®šæ—¶ä»»åŠ¡)
create or replace function public.cleanup_expired_data() returns void language plpgsql security definer as $$
begin
  -- åˆ é™¤7å¤©å‰ä¸”æœªå…¬å¼€çš„ç…§ç‰‡
  delete from public.album_photos where created_at < now() - interval '7 days' and is_public = false;
  -- åˆ é™¤ç©ºæ–‡ä»¶å¤¹
  delete from public.album_folders 
  where id not in (select distinct folder_id from public.album_photos where folder_id is not null)
  and created_at < now() - interval '24 hours';
end; $$;