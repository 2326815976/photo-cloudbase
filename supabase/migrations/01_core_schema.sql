-- ================================================================================================
-- ğŸ“‚ é¡¹ç›®ï¼šæ‹¾å…‰è°£ (Time Ballad) - æ ¸å¿ƒæ•°æ®åº“ç»“æ„
-- ğŸ“ ç‰ˆæœ¬ï¼šv2.0_Consolidated
-- ğŸ¯ ç›®æ ‡ï¼šæ ¸å¿ƒè¡¨ç»“æ„ã€ç”¨æˆ·ç³»ç»Ÿã€æ‘†å§¿ç³»ç»Ÿã€ç›¸å†Œç³»ç»Ÿã€ç…§ç‰‡ç³»ç»Ÿã€ç‰ˆæœ¬å‘å¸ƒ
-- ğŸ“… æ—¥æœŸï¼š2026-02-05
-- ğŸ”„ åˆå¹¶è‡ªï¼š001, 002, 007, 010, 09_fix_user_registration.sql, 14_unify_timezone_handling.sql
-- ================================================================================================

-- [å…¨å±€é…ç½®] è®¾ç½®UTCæ—¶åŒºï¼Œä¸åº”ç”¨å±‚ä¿æŒä¸€è‡´
ALTER DATABASE postgres SET timezone TO 'UTC';

-- åˆå§‹åŒ– UUID ç”Ÿæˆæ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ================================================================================================
-- 1. ç”¨æˆ·ç³»ç»Ÿ (Profiles)
-- ================================================================================================

-- è¡¨ï¼šç”¨æˆ·æ¡£æ¡ˆ
CREATE TABLE IF NOT EXISTS public.profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email text,
  name text,
  nickname text,
  avatar text,
  role text DEFAULT 'user' CHECK (role IN ('user', 'admin')),

  -- è”ç³»æ–¹å¼
  phone text,
  wechat text,

  -- ç®¡ç†å‘˜æ”¶æ¬¾ç  (ä»…å½“ role='admin' æ—¶æœ‰æ„ä¹‰)
  payment_qr_code text,

  created_at timestamptz DEFAULT now(),
  last_active_at timestamptz
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX IF NOT EXISTS idx_profiles_phone ON public.profiles(phone) WHERE phone IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_profiles_wechat ON public.profiles(wechat) WHERE wechat IS NOT NULL;

-- RLS ç­–ç•¥
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public view profiles" ON profiles FOR SELECT USING (true);
CREATE POLICY "User update own" ON profiles FOR UPDATE USING (auth.uid() = id);

-- å­—æ®µæ³¨é‡Š
COMMENT ON COLUMN public.profiles.nickname IS 'ç”¨æˆ·æ˜µç§°ï¼Œç”¨äºè¯„è®ºæ˜¾ç¤º';
COMMENT ON COLUMN public.profiles.phone IS 'ç”¨æˆ·æ‰‹æœºå·';
COMMENT ON COLUMN public.profiles.wechat IS 'ç”¨æˆ·å¾®ä¿¡å·';

-- ================================================================================================
-- 2. ç»Ÿè®¡ç³»ç»Ÿ (Analytics)
-- ================================================================================================

-- è¡¨ï¼šç”¨æˆ·æ—¥æ´»æµæ°´
CREATE TABLE IF NOT EXISTS public.user_active_logs (
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  active_date date DEFAULT CURRENT_DATE,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (user_id, active_date)
);

-- è¡¨ï¼šä»ªè¡¨ç›˜æ¯æ—¥å¿«ç…§ (ç¼“å­˜è¡¨ï¼Œæå¤§æå‡åå°åŠ è½½é€Ÿåº¦)
CREATE TABLE IF NOT EXISTS public.analytics_daily (
  date date PRIMARY KEY DEFAULT CURRENT_DATE,
  new_users_count int DEFAULT 0,
  active_users_count int DEFAULT 0
);

-- RLS ç­–ç•¥
ALTER TABLE public.user_active_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.analytics_daily ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Log write" ON user_active_logs FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Admin read stats" ON analytics_daily FOR SELECT USING (
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

-- ================================================================================================
-- 3. æ‘†å§¿èµ„æºç³»ç»Ÿ (Poses & Tags)
-- ================================================================================================

-- è¡¨ï¼šæ‹ç…§å§¿åŠ¿
CREATE TABLE IF NOT EXISTS public.poses (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  image_url text NOT NULL,
  storage_path text,
  tags text[],
  view_count int DEFAULT 0,
  created_at timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS poses_tags_idx ON public.poses USING gin (tags);

-- è¡¨ï¼šæ‘†å§¿æ ‡ç­¾
CREATE TABLE IF NOT EXISTS public.pose_tags (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name text NOT NULL UNIQUE,
  usage_count int DEFAULT 0,
  created_at timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS pose_tags_name_idx ON public.pose_tags(name);

-- RLS ç­–ç•¥
ALTER TABLE public.poses ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public read poses" ON poses FOR SELECT USING (true);
CREATE POLICY "Admin manage poses" ON poses FOR ALL USING (
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

ALTER TABLE public.pose_tags ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public read tags" ON pose_tags FOR SELECT USING (true);
CREATE POLICY "Admin manage tags" ON pose_tags FOR ALL USING (
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

-- ================================================================================================
-- 4. ä¸“å±è¿”å›¾ç©ºé—´ (Albums)
-- ================================================================================================

-- è¡¨ï¼šç›¸å†Œ
CREATE TABLE IF NOT EXISTS public.albums (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  access_key text NOT NULL UNIQUE,
  title text,
  cover_url text,
  welcome_letter text,
  recipient_name text DEFAULT 'æ‹¾å…‰è€…',
  enable_tipping boolean DEFAULT true,
  donation_qr_code_url text,
  expires_at timestamptz,
  created_by uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_albums_expires_at ON public.albums(expires_at) WHERE expires_at IS NOT NULL;

-- è¡¨ï¼šç›¸å†Œæ–‡ä»¶å¤¹
CREATE TABLE IF NOT EXISTS public.album_folders (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  album_id uuid REFERENCES public.albums(id) ON DELETE CASCADE NOT NULL,
  name text NOT NULL,
  created_at timestamptz DEFAULT now()
);

-- RLS ç­–ç•¥
ALTER TABLE public.albums ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Admin manage albums" ON albums FOR ALL USING (
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

ALTER TABLE public.album_folders ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Admin manage folders" ON album_folders FOR ALL USING (
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

-- å­—æ®µæ³¨é‡Š
COMMENT ON COLUMN public.albums.expires_at IS 'ç›¸å†Œè¿‡æœŸæ—¶é—´';
COMMENT ON COLUMN public.albums.recipient_name IS 'æ”¶ä»¶äººåç§°ï¼Œé»˜è®¤ä¸º"æ‹¾å…‰è€…"';
COMMENT ON COLUMN public.albums.donation_qr_code_url IS 'èµèµç å›¾ç‰‡URL';
COMMENT ON COLUMN public.albums.created_by IS 'ç›¸å†Œåˆ›å»ºè€…ï¼Œç”¨äºçº§è”åˆ é™¤';

-- ================================================================================================
-- 5. ç…§ç‰‡ä¸äº’åŠ¨ (Photos, Comments, Likes)
-- ================================================================================================

-- è¡¨ï¼šç…§ç‰‡
CREATE TABLE IF NOT EXISTS public.album_photos (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  album_id uuid REFERENCES public.albums(id) ON DELETE CASCADE NOT NULL,
  folder_id uuid REFERENCES public.album_folders(id) ON DELETE SET NULL,

  -- å…¼å®¹å­—æ®µï¼ˆä¿ç•™ç”¨äºå‘åå…¼å®¹ï¼‰
  url text,

  -- å¤šç‰ˆæœ¬å›¾ç‰‡URL
  thumbnail_url text,
  preview_url text,
  original_url text,

  width int,
  height int,
  blurhash text,

  is_public boolean DEFAULT false,

  view_count int DEFAULT 0,
  like_count int DEFAULT 0,
  rating int DEFAULT 0,
  created_at timestamptz DEFAULT now()
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX IF NOT EXISTS idx_photos_public_wall ON public.album_photos(created_at DESC) WHERE is_public = true;
CREATE INDEX IF NOT EXISTS idx_album_photos_created_at ON public.album_photos(created_at) WHERE is_public = false;
CREATE INDEX IF NOT EXISTS idx_album_photos_thumbnail_url ON public.album_photos(thumbnail_url) WHERE thumbnail_url IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_album_photos_preview_url ON public.album_photos(preview_url) WHERE preview_url IS NOT NULL;

-- è¡¨ï¼šç…§ç‰‡è¯„è®º
CREATE TABLE IF NOT EXISTS public.photo_comments (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  photo_id uuid REFERENCES public.album_photos(id) ON DELETE CASCADE NOT NULL,
  user_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
  nickname text DEFAULT 'è®¿å®¢',
  content text NOT NULL,
  is_admin_reply boolean DEFAULT false,
  created_at timestamptz DEFAULT now()
);

-- è¡¨ï¼šç‚¹èµ
CREATE TABLE IF NOT EXISTS public.photo_likes (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  photo_id uuid REFERENCES public.album_photos(id) ON DELETE CASCADE NOT NULL,
  created_at timestamptz DEFAULT now(),
  UNIQUE(user_id, photo_id)
);

-- RLS ç­–ç•¥
ALTER TABLE public.album_photos ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public photos visible" ON album_photos FOR SELECT USING (is_public = true);
CREATE POLICY "Admin manage photos" ON album_photos FOR ALL USING (
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

ALTER TABLE public.photo_comments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "View comments" ON photo_comments FOR SELECT USING (true);
CREATE POLICY "Admin manage comments" ON photo_comments FOR ALL USING (
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

ALTER TABLE public.photo_likes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "User like" ON photo_likes FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "User unlike" ON photo_likes FOR DELETE USING (auth.uid() = user_id);
CREATE POLICY "Public view likes" ON photo_likes FOR SELECT USING (true);

-- å­—æ®µæ³¨é‡Š
COMMENT ON COLUMN public.album_photos.url IS 'å…¼å®¹å­—æ®µ - æ–°æ•°æ®ä½¿ç”¨ thumbnail_url/preview_url/original_url';
COMMENT ON COLUMN public.album_photos.thumbnail_url IS 'é€Ÿè§ˆå›¾URL - ç”¨äºåˆ—è¡¨å¿«é€ŸåŠ è½½ (300px, è´¨é‡75)';
COMMENT ON COLUMN public.album_photos.preview_url IS 'é«˜è´¨é‡é¢„è§ˆURL - ç”¨äºç‚¹å‡»é¢„è§ˆ (1200px, è´¨é‡85)';
COMMENT ON COLUMN public.album_photos.original_url IS 'åŸå›¾URL - ä»…è¿”å›¾ç©ºé—´ï¼Œç”¨äºä¸‹è½½ (å®Œæ•´è´¨é‡)';

-- ================================================================================================
-- 6. ç‰ˆæœ¬å‘å¸ƒ (Releases)
-- ================================================================================================

CREATE TABLE IF NOT EXISTS public.app_releases (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  version text NOT NULL,
  platform text NOT NULL,
  download_url text NOT NULL,
  update_log text,
  force_update boolean DEFAULT false,
  created_at timestamptz DEFAULT now()
);

ALTER TABLE public.app_releases ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public read releases" ON app_releases FOR SELECT USING (true);
CREATE POLICY "Admin manage releases" ON app_releases FOR ALL USING (
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

COMMENT ON COLUMN public.app_releases.force_update IS 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼štrue=å¼ºåˆ¶æ›´æ–°ï¼ˆå¼¹çª—ä¸å¯å…³é—­ï¼‰ï¼Œfalse=å¯é€‰æ›´æ–°ï¼ˆå¼¹çª—å¯å…³é—­ï¼‰';

-- ================================================================================================
-- 7. æ ¸å¿ƒ RPC æ¥å£
-- ================================================================================================

-- å‘è¡¨è¯„è®º (å¸¦å¯†é’¥æ ¡éªŒ)
CREATE OR REPLACE FUNCTION public.post_album_comment(
  p_access_key text,
  p_photo_id uuid,
  p_content text
)
RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
  valid_album_id uuid;
  v_user_id uuid;
  v_nickname text;
BEGIN
  v_user_id := auth.uid();

  -- è¶Šæƒæ£€æµ‹ï¼šéªŒè¯ Key æ˜¯å¦å¯¹åº”ç…§ç‰‡æ‰€å±ç›¸å†Œ
  SELECT a.id INTO valid_album_id
  FROM public.albums a
  JOIN public.album_photos p ON p.album_id = a.id
  WHERE a.access_key = p_access_key AND p.id = p_photo_id;

  IF valid_album_id IS NULL THEN
    RAISE EXCEPTION 'æ— æƒæ“ä½œï¼šå¯†é’¥é”™è¯¯æˆ–ç…§ç‰‡ä¸å±äºè¯¥ç©ºé—´';
  END IF;

  -- è·å–ç”¨æˆ·æ˜µç§°ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
  IF v_user_id IS NOT NULL THEN
    SELECT nickname INTO v_nickname FROM public.profiles WHERE id = v_user_id;
  END IF;

  INSERT INTO public.photo_comments (photo_id, user_id, content, nickname)
  VALUES (p_photo_id, v_user_id, p_content, COALESCE(v_nickname, 'è®¿å®¢'));
END;
$$;

-- è·å–ç…§ç‰‡å¢™ (å…¬å¼€)
CREATE OR REPLACE FUNCTION public.get_public_gallery(page_no int, page_size int)
RETURNS jsonb LANGUAGE sql SECURITY DEFINER AS $$
  SELECT json_agg(t) FROM (
    SELECT
      p.id,
      COALESCE(p.thumbnail_url, p.url) as thumbnail_url,
      COALESCE(p.preview_url, p.url) as preview_url,
      p.width, p.height, p.blurhash,
      p.like_count, p.view_count, p.created_at,
      EXISTS(SELECT 1 FROM public.photo_likes pl WHERE pl.photo_id = p.id AND pl.user_id = auth.uid()) as is_liked
    FROM public.album_photos p
    WHERE p.is_public = true
    ORDER BY p.created_at DESC
    LIMIT page_size
    OFFSET (page_no - 1) * page_size
  ) t;
$$;

-- ================================================================================================
-- 8. è‡ªåŠ¨åŒ– Triggers
-- ================================================================================================

-- æ–°ç”¨æˆ·æ³¨å†Œ -> å†™å…¥ Profiles (ä¿®å¤ç‰ˆï¼šä» user_metadata è¯»å–æ‰‹æœºå·ï¼Œè®¾ç½®é»˜è®¤ç”¨æˆ·å)
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, name, nickname, phone, role)
  VALUES (
    new.id,
    new.email,
    'æ‹¾å…‰è€…', -- é»˜è®¤ç”¨æˆ·å
    'æ‹¾å…‰è€…', -- é»˜è®¤æ˜µç§°
    new.raw_user_meta_data->>'phone', -- ä» user_metadata ä¸­è¯»å–æ‰‹æœºå·
    'user'
  );

  -- æ›´æ–°æ—¥å¢ç”¨æˆ·ç»Ÿè®¡
  INSERT INTO public.analytics_daily (date, new_users_count) VALUES (CURRENT_DATE, 1)
  ON CONFLICT (date) DO UPDATE SET new_users_count = analytics_daily.new_users_count + 1;

  RETURN new;
END;
$$;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE PROCEDURE public.handle_new_user();

-- æ›´æ–°ç”¨æˆ·æœ€åæ´»è·ƒæ—¶é—´
CREATE OR REPLACE FUNCTION public.update_last_active()
RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  UPDATE public.profiles
  SET last_active_at = now()
  WHERE id = new.user_id;
  RETURN new;
END;
$$;

DROP TRIGGER IF EXISTS on_user_active ON public.user_active_logs;
CREATE TRIGGER on_user_active
  AFTER INSERT ON public.user_active_logs
  FOR EACH ROW
  EXECUTE FUNCTION public.update_last_active();

-- åˆ é™¤æ ‡ç­¾æ—¶è‡ªåŠ¨ä»æ‰€æœ‰æ‘†å§¿ä¸­ç§»é™¤è¯¥æ ‡ç­¾
CREATE OR REPLACE FUNCTION public.remove_tag_from_poses()
RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  UPDATE public.poses
  SET tags = array_remove(tags, old.name)
  WHERE old.name = ANY(tags);
  RETURN old;
END;
$$;

DROP TRIGGER IF EXISTS trigger_remove_tag_from_poses ON public.pose_tags;
CREATE TRIGGER trigger_remove_tag_from_poses
  AFTER DELETE ON public.pose_tags
  FOR EACH ROW
  EXECUTE PROCEDURE public.remove_tag_from_poses();

-- æ›´æ–°æ ‡ç­¾ä½¿ç”¨æ¬¡æ•°
CREATE OR REPLACE FUNCTION public.update_tag_usage_count()
RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
  tag_name text;
BEGIN
  IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
    FOREACH tag_name IN ARRAY new.tags
    LOOP
      UPDATE public.pose_tags
      SET usage_count = (
        SELECT count(*) FROM public.poses WHERE tag_name = ANY(tags)
      )
      WHERE name = tag_name;
    END LOOP;
  END IF;

  IF TG_OP = 'DELETE' OR TG_OP = 'UPDATE' THEN
    FOREACH tag_name IN ARRAY old.tags
    LOOP
      UPDATE public.pose_tags
      SET usage_count = (
        SELECT count(*) FROM public.poses WHERE tag_name = ANY(tags)
      )
      WHERE name = tag_name;
    END LOOP;
  END IF;

  RETURN new;
END;
$$;

DROP TRIGGER IF EXISTS trigger_update_tag_usage_count ON public.poses;
CREATE TRIGGER trigger_update_tag_usage_count
  AFTER INSERT OR UPDATE OR DELETE ON public.poses
  FOR EACH ROW
  EXECUTE PROCEDURE public.update_tag_usage_count();

-- ================================================================================================
-- å®Œæˆ
-- ================================================================================================

DO $$
BEGIN
  RAISE NOTICE 'âœ… æ ¸å¿ƒæ•°æ®åº“ç»“æ„åˆ›å»ºå®Œæˆï¼';
  RAISE NOTICE 'ğŸ“Š å·²åˆ›å»ºï¼šç”¨æˆ·ç³»ç»Ÿã€ç»Ÿè®¡ç³»ç»Ÿã€æ‘†å§¿ç³»ç»Ÿã€ç›¸å†Œç³»ç»Ÿã€ç…§ç‰‡ç³»ç»Ÿã€ç‰ˆæœ¬å‘å¸ƒ';
  RAISE NOTICE 'ğŸ”’ RLS ç­–ç•¥å·²é…ç½®';
  RAISE NOTICE 'âš¡ è§¦å‘å™¨å·²è®¾ç½®';
  RAISE NOTICE 'ğŸ”„ å·²æ•´åˆï¼šç”¨æˆ·æ³¨å†Œä¿®å¤ã€UTCæ—¶åŒºè®¾ç½®';
END $$;
