-- ================================================================================================
-- ğŸ“‚ é¡¹ç›®ï¼šæ‹¾å…‰è°£ - æ‘†å§¿æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ
-- ğŸ“ ç‰ˆæœ¬ï¼šv2.0 - Pose Tags System (åˆå¹¶ 002 + 004)
-- ğŸ¯ ç›®æ ‡ï¼šå®Œæ•´çš„æ‘†å§¿æ ‡ç­¾ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…å«ä¿®å¤åçš„è§¦å‘å™¨
-- ğŸ“… æ—¥æœŸï¼š2026-02-02
-- ================================================================================================

-- ================================================================================================
-- 1. æ‘†å§¿æ ‡ç­¾è¡¨
-- ================================================================================================

-- è¡¨ï¼šæ‘†å§¿æ ‡ç­¾
-- [ğŸ’» å‰ç«¯å¯¹æ¥] æ ‡ç­¾ç®¡ç†é¡µé¢çš„æ•°æ®æº
create table if not exists public.pose_tags (
  id bigint generated by default as identity primary key,
  name text not null unique, -- æ ‡ç­¾åç§°ï¼Œå”¯ä¸€çº¦æŸ
  usage_count int default 0, -- ä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡
  created_at timestamptz default now()
);

-- ç´¢å¼•ä¼˜åŒ–
create index if not exists pose_tags_name_idx on public.pose_tags(name);

-- RLS ç­–ç•¥
alter table public.pose_tags enable row level security;
create policy "Public read tags" on pose_tags for select using (true);
create policy "Admin manage tags" on pose_tags for all using (exists (select 1 from profiles where id = auth.uid() and role = 'admin'));

-- ================================================================================================
-- 2. è§¦å‘å™¨ï¼šåˆ é™¤æ ‡ç­¾æ—¶è‡ªåŠ¨ä»æ‰€æœ‰æ‘†å§¿ä¸­ç§»é™¤è¯¥æ ‡ç­¾ï¼ˆä¿®å¤ç‰ˆï¼‰
-- ================================================================================================

-- åˆ é™¤æ—§è§¦å‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
drop trigger if exists trigger_remove_tag_from_poses on public.pose_tags;

-- åˆ é™¤æ ‡ç­¾æ—¶è‡ªåŠ¨ä»æ‰€æœ‰æ‘†å§¿ä¸­ç§»é™¤è¯¥æ ‡ç­¾ï¼ˆæ”¹ä¸ºAFTER DELETEï¼‰
create or replace function public.remove_tag_from_poses()
returns trigger language plpgsql security definer as $$
begin
  -- ä»æ‰€æœ‰posesçš„tagsæ•°ç»„ä¸­ç§»é™¤è¢«åˆ é™¤çš„æ ‡ç­¾
  update public.poses
  set tags = array_remove(tags, old.name)
  where old.name = any(tags);

  return old;
end;
$$;

-- æ”¹ä¸ºAFTER DELETEï¼Œé¿å…ä¸usage_countæ›´æ–°å†²çª
create trigger trigger_remove_tag_from_poses
  after delete on public.pose_tags
  for each row
  execute procedure public.remove_tag_from_poses();

-- ================================================================================================
-- 3. è§¦å‘å™¨ï¼šæ›´æ–°æ ‡ç­¾ä½¿ç”¨æ¬¡æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
-- ================================================================================================

-- åˆ é™¤æ—§è§¦å‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
drop trigger if exists trigger_update_tag_usage_count on public.poses;

-- æ›´æ–°æ ‡ç­¾ä½¿ç”¨æ¬¡æ•°ï¼ˆæ·»åŠ å­˜åœ¨æ€§æ£€æŸ¥ï¼‰
create or replace function public.update_tag_usage_count()
returns trigger language plpgsql security definer as $$
declare
  tag_name text;
begin
  -- å½“posesè¡¨çš„tagså­—æ®µå˜åŒ–æ—¶ï¼Œæ›´æ–°ç›¸å…³æ ‡ç­¾çš„ä½¿ç”¨æ¬¡æ•°
  if TG_OP = 'INSERT' or TG_OP = 'UPDATE' then
    -- æ›´æ–°æ–°æ ‡ç­¾çš„ä½¿ç”¨æ¬¡æ•°
    foreach tag_name in array new.tags
    loop
      -- åªæ›´æ–°å­˜åœ¨çš„æ ‡ç­¾
      update public.pose_tags
      set usage_count = (
        select count(*) from public.poses where tag_name = any(tags)
      )
      where name = tag_name;
    end loop;
  end if;

  if TG_OP = 'DELETE' or TG_OP = 'UPDATE' then
    -- æ›´æ–°æ—§æ ‡ç­¾çš„ä½¿ç”¨æ¬¡æ•°
    foreach tag_name in array old.tags
    loop
      -- åªæ›´æ–°å­˜åœ¨çš„æ ‡ç­¾ï¼ˆå¦‚æœæ ‡ç­¾å·²è¢«åˆ é™¤åˆ™è·³è¿‡ï¼‰
      update public.pose_tags
      set usage_count = (
        select count(*) from public.poses where tag_name = any(tags)
      )
      where name = tag_name;
    end loop;
  end if;

  return new;
end;
$$;

create trigger trigger_update_tag_usage_count
  after insert or update or delete on public.poses
  for each row
  execute procedure public.update_tag_usage_count();

-- ================================================================================================
-- å®Œæˆ
-- ================================================================================================

DO $$
BEGIN
  RAISE NOTICE 'âœ… æ‘†å§¿æ ‡ç­¾ç³»ç»Ÿåˆ›å»ºå®Œæˆï¼';
  RAISE NOTICE 'ğŸ“Š å·²åˆ›å»ºè¡¨ï¼špose_tags';
  RAISE NOTICE 'ğŸ”„ å·²åˆ›å»ºè§¦å‘å™¨ï¼šåˆ é™¤æ ‡ç­¾è‡ªåŠ¨æ¸…ç† + ä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡';
  RAISE NOTICE 'ğŸ› å·²ä¿®å¤ï¼šè§¦å‘å™¨å†²çªé—®é¢˜ï¼ˆAFTER DELETEï¼‰';
END $$;
